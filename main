import os

from sqlalchemy.orm.sync import update

os.environ['OPENBLAS_NUM_THREADS'] = '1'

import telebot
from dateutil.utils import today
from numpy.testing.print_coercion_tables import print_new_cast_table
from telebot import types
import sqlalchemy.types
import pandas as pd
import psycopg2
from sqlalchemy import create_engine
import time

from datetime import datetime
from datetime import date
from dateutil.relativedelta import relativedelta
import schedule
from threading import Thread
from apscheduler.schedulers.blocking import BlockingScheduler
from apscheduler.schedulers.asyncio import AsyncIOScheduler

from sqlalchemy import create_engine
from sqlalchemy.sql import insert,update
from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Session
from sqlalchemy.orm import sessionmaker
from sqlalchemy import  Column, Integer, String

bot = telebot.TeleBot('________________')

engine = create_engine('postgresql+psycopg2://____________', connect_args={'client_encoding': 'utf8'})
conn = psycopg2.connect("host=_____ dbname=______ user=_______ password=_____")
cur = conn.cursor()

# ПОЛУЧЕНИЕ БАЗ ДАННЫХ

## БАЗА ДАННЫХ О ПОЛЬЗОВАТЕЛЯХ

class Base(DeclarativeBase): pass
class User_data(Base):
    __tablename__ = "user_data"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer)
    name = Column(String)
    tipe = Column(String)

Base.metadata.create_all(bind=engine)

with Session(autoflush=False, bind=engine) as ud:
    data_user = User_data()

## БАЗА ДАННЫХ О КРЕДИТАХ

class Base(DeclarativeBase): pass
class Credit_data(Base):
    __tablename__ = "credit_data"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer)
    name_cred = Column(String)
    cred_limit = Column(Integer)
    stert_date = Column(String)
    end_data = Column(String)
    mon_payment = Column(Integer)
    limit_today =  Column(Integer)
    proc = Column(Integer)
    day_pay = Column(String)

Base.metadata.create_all(bind=engine)

with Session(autoflush=False, bind=engine) as cd:
    data_credit = Credit_data()

## БАЗА ДАННЫХ О ДЕПОЗИТАХ

class Debet_data(Base):
    __tablename__ = "debet_data"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer)
    name_debet = Column(String)
    sum_debet = Column(Integer)
    bank_name = Column(String)
    rate = Column(Integer)

Base.metadata.create_all(bind=engine)

with Session(autoflush=False, bind=engine) as db:
    data_debet= Debet_data()

# РЕГИСТРАЦИЯ ПОЛЬЗОВАТЕЛЯ

def auth(message):
    user = User_data(id = len(pd.read_sql_query('select id from user_data', engine)),
                     user_id=message.chat.id,
                     name=message.text,
                     tipe='user')
    ud.add(user)
    ud.commit()
    bot.send_message(message.from_user.id, text='Вы зарегистрированы!', parse_mode='Markdown')

@bot.message_handler(commands=['start'])
def get_text_messages_start(message):
    data = pd.read_sql_query(f'select name from user_data where user_id = {message.from_user.id}', engine)
    if data.empty:
        msg = bot.send_message(message.from_user.id, text='Нужно зарегистрироваться! Отправь имя и фамилию')
        bot.register_next_step_handler(msg, auth)
    else:
        s = 'Добро пожаловать, ' + data.loc[0, 'name'] + '!'
        bot.send_message(message.from_user.id, text=s, parse_mode='Markdown')

# ВНЕСЕНИЕ ДАННЫХ ПО КРЕДИТАМ

@bot.message_handler(commands=['insert_credit'])
def credit_insert(message):
    msg = bot.send_message(message.from_user.id, text='Введите данные по кредиту:\n'
                                                      'Название кредита?')
    bot.register_next_step_handler(msg, credit_insert_2)

def credit_insert_2(message):
    answer = message.text
    msg = bot.send_message(message.from_user.id, text='Сумма кредита который был взят?\nФормат написания: 1000.00')
    bot.register_next_step_handler(msg, credit_insert_3, answer)
    bot.delete_message(message.chat.id, message.message_id)
    bot.delete_message(message.chat.id, message.message_id - 1)

def credit_insert_3(message, answer):
    answer_2 = answer + '//' + message.text
    msg = bot.send_message(message.from_user.id, text='Дата когда был взят кредит?\nФормат написания: 2000-01-01')
    bot.register_next_step_handler(msg, credit_insert_4, answer_2)
    bot.delete_message(message.chat.id, message.message_id)
    bot.delete_message(message.chat.id, message.message_id - 1)

def credit_insert_4(message, answer_2):
    answer_3 = answer_2 + '//' + message.text
    msg = bot.send_message(message.from_user.id, text='Дата окончания кредита?\nФормат написания: 2000-01-01')
    bot.register_next_step_handler(msg, credit_insert_5, answer_3)
    bot.delete_message(message.chat.id, message.message_id)
    bot.delete_message(message.chat.id, message.message_id - 1)

def credit_insert_5(message, answer_3):
    answer_4 = answer_3 + '//' + message.text
    msg = bot.send_message(message.from_user.id, text='Сумма ежемесячного платежа?\nФормат написания: 1000.00')
    bot.register_next_step_handler(msg, credit_insert_6, answer_4)
    bot.delete_message(message.chat.id, message.message_id)
    bot.delete_message(message.chat.id, message.message_id - 1)

def credit_insert_6(message, answer_4):
    answer_5 = answer_4 + '//' + message.text
    msg = bot.send_message(message.from_user.id, text='Остаток долга?\nФормат написания: 1000.00')
    bot.register_next_step_handler(msg, credit_insert_7, answer_5)
    bot.delete_message(message.chat.id, message.message_id)
    bot.delete_message(message.chat.id, message.message_id - 1)

def credit_insert_7(message, answer_5):
    answer_6 = answer_5 + '//' + message.text
    msg = bot.send_message(message.from_user.id, text='Процентная ставка?\nФормат написания: 5%')
    bot.register_next_step_handler(msg, credit_insert_8, answer_6)
    bot.delete_message(message.chat.id, message.message_id)
    bot.delete_message(message.chat.id, message.message_id - 1)

def credit_insert_8(message, answer_6):
    answer_7 = answer_6 + '//' + str(float((message.text).replace("%",""))/100)
    msg = bot.send_message(message.from_user.id, text='Дата платежа?\nФормат написания: 2000-01-01')
    bot.register_next_step_handler(msg, credit_insert_9, answer_7)
    bot.delete_message(message.chat.id, message.message_id)
    bot.delete_message(message.chat.id, message.message_id - 1)

def credit_insert_9(message, answer_7):
    answer_total = (answer_7 + '//' + message.text).split('//')

    cred = Credit_data(id=len(pd.read_sql_query('select id from credit_data', engine)),
                       user_id=message.chat.id,
                       name_cred=answer_total[0],
                       cred_limit=answer_total[1],
                       stert_date=answer_total[2],
                       end_data=answer_total[3],
                       mon_payment=answer_total[4],
                       limit_today=answer_total[5],
                       proc=answer_total[6],
                       day_pay=answer_total[7]
                       )

    cd.add(cred)
    cd.commit()
    bot.send_message(message.from_user.id, text='Запись созранена!', parse_mode='Markdown')
    bot.delete_message(message.chat.id, message.message_id)
    bot.delete_message(message.chat.id, message.message_id - 1)

# УДАЛЕНИЕ ИНФОРМАЦИИ ПО КРЕДИТУ

@bot.message_handler(commands=['delete_credit'])
def delete_credit(message):
    list_name = list(pd.read_sql_query(f'select * from credit_data '
                                       f'where user_id = {message.chat.id}', engine).name_cred)
    mm = types.ReplyKeyboardMarkup(row_width=2)
    for i in list_name:
        mm.add(types.KeyboardButton(i))

    msg = bot.send_message(message.chat.id, text='Какой кредит удалить?', reply_markup=mm)
    bot.register_next_step_handler(msg, delete_credit_2)

def delete_credit_2(message):
    credit = cd.query(Credit_data).filter(and_(Credit_data.name_cred == message.text,
                                               Credit_data.user_id == message.chat.id)).first()
    cd.delete(credit)
    cd.commit()

    a = telebot.types.ReplyKeyboardRemove()
    bot.send_message(message.chat.id, text= f'Кредит удален: {message.text}!', reply_markup=a)

# ЗАПРОС ДАННЫХ О КРЕДИТАХ

## ПРОВЕРКА НА НАЛИЧИЕ ЗАПИСЕЙ
@bot.message_handler(func=lambda message: message.chat.id not in list(pd.read_sql_query('select * from credit_data', engine).user_id.drop_duplicates()),
                     commands=['pay', 'day'])
def some(message):
    bot.send_message(message.chat.id, 'Нет записей о наличии кредитов.')

## ОТПРАВКА СООБЩЕНИЯ О СУММЕ ПЛАТЕЖА
@bot.message_handler(commands=['pay'])
def get_text_messages_summ_cred(message):
    data_pay = pd.read_sql_query(f"select * from credit_data where user_id = {message.chat.id}", engine)

    s = '*Сумма платежей по кредитам*\n\n'
    for i in range(len(data_pay)):
        s = (s + '*' + data_pay.loc[i, 'name_cred'] + '*' + ' платеж по кредиту составляет ' +
             '{:,.2f}'.format(data_pay.loc[i, 'mon_payment']) + ' рублей. \n\n')

    s += '*итого сумма в мес.* : ' + '{:,.2f}'.format(sum(data_pay['mon_payment'])) + ' рублей'

    bot.delete_message(message.chat.id, message.message_id - 1)
    bot.delete_message(message.chat.id, message.message_id - 2)
    bot.send_message(message.chat.id, text= s, parse_mode='Markdown')

## ОТПРАВКА СООБЩЕНИЯ О ДАТЕ ПЛАТЕЖА
@bot.message_handler(commands=['day'])
def get_text_messages_day_pay(message):
    data_day_pay = pd.read_sql_query(f"select name_cred, day_pay, mon_payment from credit_data where user_id = {message.chat.id}", engine)
    data_pay = pd.read_sql_query(f"select * from credit_data where user_id = {message.chat.id}", engine)

    d_p = '*Даты платежей по кредитам* \n\n'
    for i in range(len(data_day_pay)):
        d_p = (d_p + '*' + data_pay.loc[i, 'name_cred'] + '*' + ' дата платежа: ' + data_pay.loc[i, 'day_pay']
               + ', сумма платежа: ' + '{:,.2f}'.format(data_pay.loc[i, 'mon_payment']) + ' рублей. \n\n')

    bot.delete_message(message.chat.id, message.message_id - 1)
    bot.delete_message(message.chat.id, message.message_id - 2)
    bot.send_message(message.chat.id, text= d_p, parse_mode='Markdown')

# ВНЕСЕНИЕ ДАННЫХ ПО ДЕПОЗИТАМ

def debet_insert(message):
    data = message.text.split(', ')
    debet = Debet_data(id = len(pd.read_sql_query('select id from debet_data', engine)),
                       name_debet = data[0],
                       user_id = message.chat.id,
                       sum_debet = data[1],
                       bank_name = data[2],
                       rate = data[3]
    )

    db.add(debet)
    db.commit()

    bot.delete_message(message.chat.id, message.message_id - 2)
    bot.send_message(message.from_user.id, text='Запись сохранена!', parse_mode='Markdown')

@bot.message_handler(commands=['insert_debet'])
def get_text_debet_insert(message):
    msg = bot.send_message(message.from_user.id, text='Введите данные по депозитам в следующем формате:\n'
                                                      'название депозита, сумма депозита, '
                                                      'название банка,'
                                                      'процентная ставка\n\n'
                                                      'Пример написания:\n'
                                                      'name, 10000, bank, 0.30')

    bot.delete_message(message.chat.id, message.message_id - 1)
    bot.delete_message(message.chat.id, message.message_id - 2)
    bot.register_next_step_handler(msg, debet_insert)

# ЗАПРОС ДАННЫХ О ДЕПОЗИТАХ

## ПРОВЕРКА НА НАЛИЧИЕ ЗАПИСЕЙ
@bot.message_handler(func=lambda message: message.chat.id not in list(pd.read_sql_query('select * from debet_data', engine).user_id.drop_duplicates()),
                     commands=['deposit'])
def some(message):
    bot.delete_message(message.chat.id, message.message_id - 1)
    bot.delete_message(message.chat.id, message.message_id - 2)
    bot.send_message(message.chat.id, 'Нет записей о наличии депозитов.')

## СУММА НА ДЕПОЗИТАХ
@bot.message_handler(commands=['deposit'])
def get_text_messages_summ_deposit(message):
    data = pd.read_sql_query(f"select * from debet_data where user_id = {message.chat.id}", engine)

    dp = '*Накопления*\n\n'
    for i in range(len(data)):
        dp = dp + 'Сумма: ' + '{:,.2f}'.format(data.loc[i, 'sum_debet']) + ' руб.\n'
    dp += '\n*итого сумма* : ' + '{:,.2f}'.format(sum(data['sum_debet'])) + ' рублей'

    bot.delete_message(message.chat.id, message.message_id - 2)
    bot.send_message(message.from_user.id, text= dp, parse_mode='Markdown')

## ОБНОВЛЕНИЕ СВЕДЕНИЙ О ДЕПОЗИТЕ
@bot.message_handler(commands=['update_deposit'])
def update_dposit(message):
    list_name = list(pd.read_sql_query('select * from debet_data', engine).name_debet)

    mm = types.ReplyKeyboardMarkup(row_width=2)
    for i in list_name:
        mm.add(types.KeyboardButton(i))

    msg = bot.send_message(message.chat.id, text='Какой депозит небходимо исправить?', reply_markup=mm)
    bot.register_next_step_handler(msg, update_dposit_1)

def update_dposit_1(message):
    answer = message.text
    list_name_2 = ['Сумма депозита', 'Процентная ставка', 'Название банка', 'Название депозита']
    mm = types.ReplyKeyboardMarkup(row_width=2)
    for i in list_name_2:
        mm.add(types.KeyboardButton(i))

    msg = bot.send_message(message.from_user.id, text='Что необходимо исправить?', reply_markup=mm)
    bot.register_next_step_handler(msg, update_dposit_2, answer)

def update_dposit_2(message, answer):
    answer_2 = answer + '//' + message.text
    a = telebot.types.ReplyKeyboardRemove()
    msg = bot.send_message(message.from_user.id, text='Введите новое значение', reply_markup=a)
    bot.register_next_step_handler(msg, update_dposit_3, answer_2)

def update_dposit_3(message, answer_2):
    answer_3 = (answer_2 + '//' + message.text).split('//')

    if answer_3[1] == 'Сумма депозита':
        db.query(Debet_data).filter(Debet_data.name_debet == answer_3[0] and
                                    Debet_data.user_id == message.from_user.id).update({'sum_debet': answer_3[2]})
    elif answer_3[1] == 'Процентная ставка':
        db.query(Debet_data).filter(Debet_data.name_debet == answer_3[0] and
                                    Debet_data.user_id == message.from_user.id).update({'rate': answer_3[2]})
    elif answer_3[1] == 'Название банка':
        db.query(Debet_data).filter(Debet_data.name_debet == answer_3[0] and
                                    Debet_data.user_id == message.from_user.id).update({'bank_name': answer_3[2]})
    elif answer_3[1] == 'Название депозита':
        db.query(Debet_data).filter(Debet_data.name_debet == answer_3[0] and
                                    Debet_data.user_id == message.from_user.id).update({'name_debet': answer_3[2]})

    db.commit()

    bot.send_message(message.from_user.id, text='Данные исправлены!')
    for i in range(1, 8):
        bot.delete_message(message.chat.id, message.message_id - i)

bot.polling(none_stop=True, interval=0)
